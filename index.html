<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skins for Spotify — Vinyl / Modern / Cover</title>
  <link rel="preconnect" href="https://sdk.scdn.co" />
  <style>
    :root{
      --bg:#0b0c10; --panel:#12141a; --card:#171a22; --muted:#9aa4b2; --text:#f5f7fb; --accent:#1db954;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0c10,#0b0c10 60%,#0e1016);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    button{cursor:pointer;border:0;border-radius:12px;background:var(--accent);color:#08120b;font-weight:600;padding:.7rem 1rem;box-shadow:var(--shadow)}
    button.ghost{background:#21252e;color:var(--text);box-shadow:none}
    button.inline{padding:.5rem .75rem;border-radius:10px}
    a{color:var(--accent);text-decoration:none}
    .hidden{display:none!important}
    .wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh}

    .top{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:14px 18px;background:#0f1218;border-bottom:1px solid #1b2230;position:sticky;top:0;z-index:20}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:34px;height:34px;border-radius:12px;background:radial-gradient(circle at 35% 40%,#4cff96 0 35%, transparent 36%),radial-gradient(circle at 65% 60%,#13b85e 0 35%, transparent 36%), #0b0c10;border:1px solid #1c2a20;box-shadow:inset 0 0 0 2px rgba(19,184,94,.25);}
    .chip{display:flex;align-items:center;gap:8px;background:#141821;border:1px solid #202737;border-radius:999px;padding:6px 10px;color:var(--muted)}
    .chip img{width:20px;height:20px;border-radius:999px}

    .grid{display:grid;grid-template-columns:280px 1fr 320px;gap:16px;padding:18px}
    .panel{background:var(--panel);border:1px solid #1d2330;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;min-height:200px}
    .panel h3{margin:.2rem 0 .8rem;font-size:14px;letter-spacing:.25px;color:#c7cfdb}

    .themes{display:grid;gap:10px}
    .theme-card{display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid #232a3a;border-radius:14px;padding:10px}
    .theme-card:hover{border-color:#2d364a}
    .swatch{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 70%);position:relative;overflow:hidden}
    .swatch.vinyl::before{content:"";position:absolute;inset:0;border-radius:50%;background:radial-gradient(circle at 50% 50%, #000 0 10px, #111 11px 20px, transparent 21px),radial-gradient(circle at 50% 50%, #222 0 70%, #111 71% 100%);}
    .swatch.modern{background:linear-gradient(200deg,#1e293b,#0f172a)}
    .swatch.cover{background:linear-gradient(145deg,#7c3aed,#db2777)}

    .player{display:grid;grid-template-rows:1fr auto;gap:14px}
    .stage{display:grid;place-items:center;background:var(--card);border:1px solid #21283a;border-radius:calc(var(--radius) + 4px);min-height:420px;position:relative;overflow:hidden}
    .center-note{opacity:.7;color:var(--muted)}

    .disc{width:320px;height:320px;border-radius:50%;background:radial-gradient(circle at 50% 50%, #111 0 12px, #1b1b1b 13px 18px, #0f0f0f 19px 100%),repeating-radial-gradient(circle at 50% 50%, #0e0e0e 0 3px, #111 3px 6px);box-shadow:inset 0 0 40px rgba(0,0,0,.6), 0 30px 80px rgba(0,0,0,.35);position:relative; display:grid;place-items:center;transition:filter .2s ease}
    .disc .label{width:96px;height:96px;border-radius:50%;background:var(--accent);display:grid;place-items:center;color:#041308;font-weight:800}
    .tonearm{width:240px;height:12px;background:linear-gradient(90deg,#bbb,#eee);position:absolute;right:22%;top:18%;transform-origin:100% 50%;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.25)}
    .stylus{width:18px;height:26px;background:#333;position:absolute;right:-6px;top:-7px;border-radius:3px;transform:rotate(12deg)}

    .modern{width:75%;max-width:560px;display:grid;gap:18px}
    .glass{backdrop-filter:blur(10px);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);padding:18px;border-radius:18px}
    .progress{height:6px;background:#202838;border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:var(--accent);width:0%}

    .cover-wrap{display:grid;gap:14px;place-items:center}
    .cover{width:min(76vmin,460px);height:min(76vmin,460px);border-radius:22px;background:#222;border:1px solid #2a3143;box-shadow:var(--shadow);background-size:cover;background-position:center}

    .controls{display:flex;align-items:center;justify-content:center;gap:10px;background:#0f1218;border:1px solid #1b2230;border-radius:var(--radius);padding:10px}
    .controls .btn{background:#202636;color:#cfd6e4;border:1px solid #2a3347}
    .controls .play{background:var(--accent);color:#06240f}
    .slider{appearance:none;width:50%;height:6px;border-radius:999px;background:#1e2534;outline:none}
    .slider::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);border:2px solid #0b0c10}

    .stack{display:grid;gap:12px}
    .input{display:flex;gap:8px}
    .input input{flex:1;background:#0f1218;border:1px solid #1c2332;color:var(--text);padding:.7rem .8rem;border-radius:10px}
    .list{display:grid;gap:8px;max-height:420px;overflow:auto}
    .row{display:flex;align-items:center;gap:10px;padding:8px;border:1px solid #222a3b;background:#141822;border-radius:10px}
    .row:hover{border-color:#2a3347}
    .row img{width:40px;height:40px;border-radius:8px}
    .row .meta{display:grid}
    .muted{color:var(--muted)}

    .gate{min-height:80vh;display:grid;place-items:center;padding:24px}
    .card{background:var(--panel);border:1px solid #1d2330;border-radius:22px;box-shadow:var(--shadow);padding:24px;max-width:820px}
    .themes-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .themes-grid .pick{border:1px solid #242c3c;background:#151926;border-radius:16px;padding:16px;text-align:center}
    .themes-grid .pick:hover{border-color:#303a50}

    .tip{font-size:12px;color:#a9b3c3}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#142018;border:1px solid #1e3527;padding:4px 8px;border-radius:999px;color:#a6e9bf}

    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="top" class="top hidden">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div style="font-weight:800">Skins for Spotify</div>
          <div class="tip">Themeable player powered by Spotify</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div id="premiumBadge" class="badge hidden">Premium</div>
        <div id="userChip" class="chip hidden"><img id="userImg" alt=""/><span id="userName">—</span></div>
        <button id="switchThemeBtn" class="ghost inline">Switch Theme</button>
        <button id="logoutBtn" class="ghost inline">Log out</button>
      </div>
    </div>

    <!-- Login Gate -->
    <section id="loginGate" class="gate">
      <div class="card">
        <h1 style="margin-top:0">Make Spotify ✨pretty✨</h1>
        <p>Pick a skin (Vinyl • Modern • Cover Art) and control your Spotify with a beautiful, animated player. Works best with <strong>Spotify Premium</strong> (required for in‑browser playback).
        </p>
        <div id="diag" class="tip" style="padding:10px;border:1px dashed #334; border-radius:12px; margin:12px 0">
          <div><strong>Diagnostics</strong></div>
          <div>Origin: <code id="dOrigin"></code></div>
          <div>Path: <code id="dPath"></code></div>
          <div>Computed Redirect URI: <code id="dRedirect"></code> <button id="copyRedirect" class="inline ghost">Copy</button></div>
          <div>Client ID set: <code id="dClient">false</code></div>
          <div>Network test: <code id="dNet">pending…</code></div>
        </div>
        <ol>
          <li>Create a Spotify Developer App → add the <em>Computed Redirect URI</em> above to <strong>Redirect URIs</strong>.</li>
          <li>Paste your <code>CLIENT_ID</code> into the code (search for <em>SPOTIFY_CLIENT_ID</em>).</li>
          <li>If preview sandbox blocks requests, run locally (e.g., <code>https://yassinelnemrr.github.io/skins/</code>) and set <code>REDIRECT_URI_OVERRIDE</code>.</li>
        </ol>
        <p class="tip">No server needed — uses OAuth PKCE in the browser.</p>
        <div id="errorBox" class="tip" style="color:#ffb4b4"></div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button id="loginBtn">Continue with Spotify</button>
          <button id="popOutBtn" class="ghost">Open in new tab</button>
        </div>
      </div>
    </section>

    <!-- Theme Picker Gate -->
    <section id="themeGate" class="gate hidden">
      <div class="card">
        <h2 style="margin-top:0">Choose your vibe</h2>
        <div class="themes-grid">
          <button class="pick" data-theme="vinyl">
            <div class="swatch vinyl" style="margin:auto"></div>
            <h3>Vinyl</h3>
            <p class="tip">Spinning platter, tonearm, optional crackle SFX</p>
          </button>
          <button class="pick" data-theme="modern">
            <div class="swatch modern" style="margin:auto"></div>
            <h3>Modern</h3>
            <p class="tip">Minimal glass UI with progress ring</p>
          </button>
          <button class="pick" data-theme="cover">
            <div class="swatch cover" style="margin:auto"></div>
            <h3>Cover Art</h3>
            <p class="tip">Bold album tile with auto‑tinted accents</p>
          </button>
        </div>
        <div style="margin-top:14px;display:flex;gap:10px"><button id="confirmTheme">Use Theme</button><button id="skipTheme" class="ghost">Skip (Modern)</button></div>
      </div>
    </section>

    <!-- Main App -->
    <main id="app" class="grid hidden">
      <aside class="panel">
        <h3>Themes</h3>
        <div class="themes">
          <div class="theme-card"><div class="swatch vinyl"></div><div style="flex:1">Vinyl</div><button class="inline ghost" onclick="setTheme('vinyl')">Select</button></div>
          <div class="theme-card"><div class="swatch modern"></div><div style="flex:1">Modern</div><button class="inline ghost" onclick="setTheme('modern')">Select</button></div>
          <div class="theme-card"><div class="swatch cover"></div><div style="flex:1">Cover Art</div><button class="inline ghost" onclick="setTheme('cover')">Select</button></div>
        </div>
        <div style="height:16px"></div>
        <h3>Playlists</h3>
        <div id="playlists" class="list"></div>
      </aside>

      <section class="player">
        <div id="stage" class="stage">
          <div class="center-note">Pick a theme, search or choose a playlist</div>
        </div>
        <div class="controls">
          <button class="btn inline" id="prevBtn">⏮</button>
          <button class="btn inline play" id="playPauseBtn">▶</button>
          <button class="btn inline" id="nextBtn">⏭</button>
          <input id="seek" class="slider" type="range" min="0" max="1000" value="0" />
          <input id="vol" class="slider" type="range" min="0" max="100" value="80" title="Volume" />
        </div>
      </section>

      <aside class="panel">
        <h3>Search</h3>
        <div class="input">
          <input id="searchInput" placeholder="Songs, artists, albums…" />
          <button id="searchBtn" class="inline">Search</button>
        </div>
        <div id="results" class="list" style="margin-top:10px"></div>
      </aside>
    </main>

    <footer class="top" style="border-top:1px solid #1b2230;border-bottom:0">
      <div id="now" class="tip">—</div>
      <div class="tip">Made for Premium. Free users get previews & open-in-Spotify links.</div>
    </footer>
  </div>

  <!-- Spotify Web Playback SDK -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>
  /** CONFIG **/
  const SPOTIFY_CLIENT_ID = "31a344c1506441d1bbf4007f37c1e4ca"; // <-- put your real client id
  const REDIRECT_URI_OVERRIDE = "http://127.0.0.1:5500/index.html";
  const REDIRECT_URI = (REDIRECT_URI_OVERRIDE || (location.origin + location.pathname));
  const SCOPES = [
    'streaming','user-read-email','user-read-private',
    'user-read-playback-state','user-modify-playback-state',
    'playlist-read-private','playlist-read-collaborative'
  ];

  /** SHORTHANDS & STATE **/
  const $ = s => document.querySelector(s);
  const state = {
    access_token:null, refresh_token:null, token_expires:0,
    device_id:null, player:null, premium:false, user:null,
    theme: localStorage.getItem('skin-theme') || null,
    current: { duration:0, position:0, paused:true, track:null }
  };

  /** ELEMENTS **/
  const topBar = $('#top');
  const loginGate = $('#loginGate');
  const themeGate = $('#themeGate');
  const app = $('#app');
  const errorBox = $('#errorBox');
  const userChip = $('#userChip');
  const userName = $('#userName');
  const userImg = $('#userImg');
  const premiumBadge = $('#premiumBadge');
  const playlistsEl = $('#playlists');
  const resultsEl = $('#results');
  const stage = $('#stage');
  const now = $('#now');
  const playPauseBtn = $('#playPauseBtn');
  const seek = $('#seek');
  const vol = $('#vol');

  /** HELPERS **/
  function showError(err){ if(errorBox) errorBox.textContent = String(err).slice(0,500); }
  function saveSession(){ localStorage.setItem('spotify_session', JSON.stringify({ access_token: state.access_token, refresh_token: state.refresh_token, token_expires: state.token_expires })); }
  function loadSession(){ try{ const raw = localStorage.getItem('spotify_session'); if(raw) Object.assign(state, JSON.parse(raw)); }catch{} }
  function setAuthHeader(){ window.AUTH_HEADERS = { Authorization: `Bearer ${state.access_token}`, 'Content-Type':'application/json' }; }
  async function api(path, init={}){
    if(!window.AUTH_HEADERS) setAuthHeader();
    if(state.token_expires && (Date.now()/1000) > state.token_expires) await refreshToken();
    const url = path.startsWith('http') ? path : `https://api.spotify.com/v1${path}`;
    try {
      const res = await fetch(url, { ...init, headers: { ...(init.headers||{}), ...window.AUTH_HEADERS } });
      if(res.status === 401){ await refreshToken(); return api(path, init); }
      return res;
    } catch(e){ showError(`Network error calling ${path}: ${e}`); throw e; }
  }

  /** PKCE **/
  function randStr(len=64){ const a = new Uint8Array(len); crypto.getRandomValues(a); return Array.from(a, x => ('0'+x.toString(16)).slice(-2)).join(''); }
  async function sha256(base){ const data = new TextEncoder().encode(base); const hash = await crypto.subtle.digest('SHA-256', data); return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
  async function startLogin(){
    if(!SPOTIFY_CLIENT_ID || SPOTIFY_CLIENT_ID.includes('YOUR_SPOTIFY')){ showError('Set SPOTIFY_CLIENT_ID in the script.'); return; }
    const verifier = randStr(64); const challenge = await sha256(verifier);
    sessionStorage.setItem('pkce_verifier', verifier);
    const auth = new URL('https://accounts.spotify.com/authorize');
    auth.searchParams.set('response_type','code');
    auth.searchParams.set('client_id', SPOTIFY_CLIENT_ID);
    auth.searchParams.set('redirect_uri', REDIRECT_URI);
    auth.searchParams.set('code_challenge_method','S256');
    auth.searchParams.set('code_challenge', challenge);
    auth.searchParams.set('scope', SCOPES.join(' '));
    location.assign(auth.toString());
  }
  async function exchangeCodeForToken(code){
    const verifier = sessionStorage.getItem('pkce_verifier');
    const body = new URLSearchParams({ grant_type:'authorization_code', code, redirect_uri: REDIRECT_URI, client_id: SPOTIFY_CLIENT_ID, code_verifier: verifier });
    const res = await fetch('https://accounts.spotify.com/api/token',{ method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    if(!res.ok){ const text = await res.text(); throw new Error(`Token exchange failed (${res.status}). ${text}`); }
    return res.json();
  }
  async function refreshToken(){
    if(!state.refresh_token) return;
    const body = new URLSearchParams({ grant_type:'refresh_token', refresh_token: state.refresh_token, client_id: SPOTIFY_CLIENT_ID });
    const res = await fetch('https://accounts.spotify.com/api/token',{ method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    if(res.ok){ const j = await res.json(); if(j.access_token){ state.access_token = j.access_token; state.token_expires = (Date.now()/1000) + (j.expires_in||3600) - 60; saveSession(); setAuthHeader(); } }
    else { const text = await res.text(); showError(`Refresh failed (${res.status}). ${text}`); }
  }

  /** PLAYER **/
  function loadPlayer(){ return new Promise(resolve => { if(window.Spotify && window.Spotify.Player){ resolve(); return; } window.onSpotifyWebPlaybackSDKReady = () => resolve(); }); }
  async function createPlayer(){
    state.player = new Spotify.Player({ name: 'Skins Player', getOAuthToken: cb => cb(state.access_token), volume: 0.8 });
    state.player.addListener('ready', ({ device_id }) => { state.device_id = device_id; transferToDevice(); });
    state.player.addListener('not_ready', ({ device_id }) => { console.warn('Device offline', device_id); });
    state.player.addListener('player_state_changed', s => {
      if(!s) return;
      const track = s.track_window.current_track;
      state.current.duration = s.duration; state.current.position = s.position; state.current.paused = s.paused; state.current.track = track;
      updateNowPlaying(); seek.value = Math.floor((s.position / s.duration) * 1000) || 0; playPauseBtn.textContent = s.paused ? '▶' : '⏸'; updateVinylRotation();
    });
    await state.player.connect(); renderThemeShell(); ticker();
  }
  async function transferToDevice(){ if(!state.device_id) return; await api('/me/player',{ method:'PUT', body: JSON.stringify({ device_ids:[state.device_id], play:false }) }); }
  function togglePlay(){ if(state.player) state.player.togglePlay(); }

  /** UI WIRING **/
  async function init(){
    // Diagnostics
    const dO=$('#dOrigin'), dP=$('#dPath'), dR=$('#dRedirect'), dC=$('#dClient'), dN=$('#dNet');
    if(dO) dO.textContent = location.origin; if(dP) dP.textContent = location.pathname; if(dR) dR.textContent = REDIRECT_URI; if(dC) dC.textContent = (!!SPOTIFY_CLIENT_ID && !SPOTIFY_CLIENT_ID.includes('YOUR_SPOTIFY')).toString();
    const copyBtn = $('#copyRedirect'); if(copyBtn) copyBtn.onclick = ()=> navigator.clipboard.writeText(REDIRECT_URI);
    try{ const test = await fetch('https://accounts.spotify.com/.well-known/openid-configuration'); if(dN) dN.textContent = test.ok ? 'ok' : `blocked (${test.status})`; }catch{ if(dN) dN.textContent = 'blocked by sandbox / network'; }

    // OAuth callback
    const params = new URLSearchParams(location.search);
    if(params.get('code')){
      try{ const j = await exchangeCodeForToken(params.get('code')); state.access_token = j.access_token; state.refresh_token = j.refresh_token || state.refresh_token; state.token_expires = (Date.now()/1000) + (j.expires_in||3600) - 60; saveSession(); history.replaceState({}, '', REDIRECT_URI); }
      catch(e){ showError('Login failed. Check Redirect URI & Client ID.'); }
    } else { loadSession(); }

    if(!state.access_token){
      loginGate.classList.remove('hidden');
      const lb = $('#loginBtn'); if(lb) lb.onclick = startLogin;
      const pop = $('#popOutBtn'); if(pop) pop.onclick = ()=> window.open(REDIRECT_URI, '_blank', 'noopener');
      if (window.top !== window.self) { const err = document.getElementById('errorBox'); if (err) err.textContent = 'Running inside a preview sandbox can block clicks. Use “Open in new tab” or run on localhost/HTTPS.'; }
      return;
    }

    // Fetch user
    setAuthHeader();
    try{ const me = await (await api('/me')).json(); state.user = me; state.premium = (me.product === 'premium'); userName.textContent = me.display_name || me.id; userImg.src = (me.images && me.images[0] && me.images[0].url) || 'https://i.scdn.co/image/ab6775700000ee85c4c0c0c0c0c0c0c0c0c0c0c0'; userChip.classList.remove('hidden'); premiumBadge.classList.toggle('hidden', !state.premium); }
    catch{ showError('Failed to fetch /me.'); }

    // Top bar + theme
    topBar.classList.remove('hidden');
    $('#logoutBtn').onclick = logout;
    $('#switchThemeBtn').onclick = () => showThemeGate(true);
    if(!state.theme){ showThemeGate(false); } else { startApp(); }
  }

  function showThemeGate(){ loginGate.classList.add('hidden'); app.classList.add('hidden'); themeGate.classList.remove('hidden'); let chosen = state.theme || 'modern'; themeGate.querySelectorAll('.pick').forEach(btn=>{ btn.onclick = ()=>{ chosen = btn.dataset.theme; themeGate.querySelectorAll('.pick').forEach(b=>b.style.outline=''); btn.style.outline='2px solid var(--accent)'; }; }); $('#confirmTheme').onclick = ()=>{ setTheme(chosen); themeGate.classList.add('hidden'); startApp(); }; $('#skipTheme').onclick = ()=>{ setTheme('modern'); themeGate.classList.add('hidden'); startApp(); }; }
  function setTheme(name){ state.theme = name; localStorage.setItem('skin-theme', name); document.body.dataset.theme = name; renderThemeShell(); }
  function logout(){ localStorage.removeItem('spotify_session'); location.reload(); }

  async function startApp(){ themeGate.classList.add('hidden'); loginGate.classList.add('hidden'); app.classList.remove('hidden'); setTheme(state.theme || 'modern'); listPlaylists(); $('#searchBtn').onclick = doSearch; $('#searchInput').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); }); $('#prevBtn').onclick = ()=> api('/me/player/previous',{method:'POST'}); $('#nextBtn').onclick = ()=> api('/me/player/next',{method:'POST'}); playPauseBtn.onclick = togglePlay; seek.oninput = ()=> { if(!state.current.duration) return; const target = Math.floor((seek.value/1000) * state.current.duration); if(state.player) state.player.seek(target); }; vol.oninput = ()=> { if(state.player) state.player.setVolume(vol.value/100); };
    if(state.premium){ await loadPlayer(); await createPlayer(); } else { stage.innerHTML = `<div class="center-note">Logged in (Free). Full streaming requires <strong>Premium</strong>. You can still search and open tracks in Spotify, or play 30s previews when available.</div>`; renderThemeShell(); }
  }

  async function listPlaylists(){ playlistsEl.innerHTML = '<div class="tip">Loading…</div>'; const res = await api('/me/playlists?limit=30'); if(!res.ok){ playlistsEl.innerHTML = '<div class="tip">Unable to load playlists</div>'; return; } const j = await res.json(); playlistsEl.innerHTML = ''; j.items.forEach(p => { const row = document.createElement('div'); row.className='row'; row.innerHTML = `<img src="${(p.images&&p.images[0]&&p.images[0].url)||''}" alt=""/><div class="meta"><div>${p.name}</div><div class="muted">${p.tracks.total} tracks</div></div><div style="flex:1"></div><button class="inline ghost">Open</button>`; row.querySelector('button').onclick = ()=> openPlaylist(p); playlistsEl.appendChild(row); }); }

  async function openPlaylist(p){ resultsEl.innerHTML = `<div class="tip">Loading <strong>${p.name}</strong>…</div>`; const res = await api(`/playlists/${p.id}/tracks?limit=100`); const j = await res.json(); resultsEl.innerHTML = ''; (j.items||[]).forEach(item => { const t = item.track; if(!t) return; const row = document.createElement('div'); row.className='row'; const preview = t.preview_url; row.innerHTML = `<img src="${(t.album.images&&t.album.images[2]&&t.album.images[2].url)||(t.album.images&&t.album.images[0]&&t.album.images[0].url)||''}"/><div class="meta"><div>${t.name}</div><div class="muted">${t.artists.map(a=>a.name).join(', ')}</div></div><div style=\"flex:1\"></div>${state.premium ? `<button class=\"inline\">Play</button>` : (preview ? `<audio controls src=\"${preview}\" style=\"height:28px\"></audio>` : `<a class=\"inline\" href=\"https://open.spotify.com/track/${t.id}\" target=\"_blank\">Open</a>`)}`; if(state.premium){ row.querySelector('button').onclick = ()=> playFromContext(p.uri, t.uri); } resultsEl.appendChild(row); }); }

  async function doSearch(){ const q = $('#searchInput').value.trim(); if(!q) return; resultsEl.innerHTML = '<div class="tip">Searching…</div>'; const res = await api(`/search?type=track&limit=25&q=${encodeURIComponent(q)}`); const j = await res.json(); resultsEl.innerHTML = ''; (j.tracks?.items||[]).forEach(t => { const row = document.createElement('div'); row.className='row'; const preview = t.preview_url; row.innerHTML = `<img src="${(t.album.images&&t.album.images[2]&&t.album.images[2].url)||(t.album.images&&t.album.images[0]&&t.album.images[0].url)||''}"/><div class="meta"><div>${t.name}</div><div class="muted">${t.artists.map(a=>a.name).join(', ')}</div></div><div style=\"flex:1\"></div>${state.premium ? `<button class=\"inline\">Play</button>` : (preview ? `<audio controls src=\"${preview}\" style=\"height:28px\"></audio>` : `<a class=\"inline\" href=\"https://open.spotify.com/track/${t.id}\" target=\"_blank\">Open</a>`)}`; if(state.premium){ row.querySelector('button').onclick = ()=> playTrack(t.uri); } resultsEl.appendChild(row); }); }

  async function playTrack(uri){ if(!state.device_id){ await transferToDevice(); } await api(`/me/player/play?device_id=${state.device_id}`, { method:'PUT', body: JSON.stringify({ uris:[uri] }) }); }
  async function playFromContext(contextUri, offsetTrackUri){ if(!state.device_id){ await transferToDevice(); } await api(`/me/player/play?device_id=${state.device_id}`, { method:'PUT', body: JSON.stringify({ context_uri: contextUri, offset: { uri: offsetTrackUri } }) }); }

  /** THEMES **/
  let vinylEl=null, coverEl=null, modernEl=null;
  function renderThemeShell(){ stage.innerHTML = ''; const theme = state.theme || 'modern'; if(theme==='vinyl'){ const wrap=document.createElement('div'); wrap.style.position='relative'; vinylEl=document.createElement('div'); vinylEl.className='disc'; const label=document.createElement('div'); label.className='label'; label.textContent='A‑SIDE'; vinylEl.appendChild(label); const arm=document.createElement('div'); arm.className='tonearm'; const stylus=document.createElement('div'); stylus.className='stylus'; arm.appendChild(stylus); wrap.appendChild(vinylEl); wrap.appendChild(arm); stage.appendChild(wrap); }
    else if(theme==='cover'){ const wrap=document.createElement('div'); wrap.className='cover-wrap'; coverEl=document.createElement('div'); coverEl.className='cover'; wrap.appendChild(coverEl); stage.appendChild(wrap); }
    else { const wrap=document.createElement('div'); wrap.className='modern'; const card=document.createElement('div'); card.className='glass'; card.innerHTML = `<div id=\"modernTitle\" style=\"font-size:22px;font-weight:800\">—</div><div id=\"modernMeta\" class=\"muted\">—</div>`; const prog=document.createElement('div'); prog.className='progress'; const bar=document.createElement('i'); prog.appendChild(bar); modernEl=bar; wrap.appendChild(card); wrap.appendChild(prog); stage.appendChild(wrap); }
    updateNowPlaying(); }

  function updateNowPlaying(){ const t = state.current.track; if(!t){ now.textContent='—'; return; } now.textContent = `${t.name} — ${t.artists.map(a=>a.name).join(', ')} · ${msToClock(state.current.position)} / ${msToClock(state.current.duration)}`; if(vinylEl){ const arm = stage.querySelector('.tonearm'); const frac = state.current.duration ? state.current.position / state.current.duration : 0; const angle = 20 + 25 * frac; arm.style.transform = `rotate(${angle}deg)`; }
    if(coverEl){ const img = (t.album.images && t.album.images[0] && t.album.images[0].url) || ''; coverEl.style.backgroundImage = img ? `url('${img}')` : 'none'; }
    if(modernEl){ const frac = state.current.duration ? state.current.position / state.current.duration : 0; modernEl.style.width = `${Math.floor(frac*100)}%`; const title=$('#modernTitle'), meta=$('#modernMeta'); if(title) title.textContent = t.name; if(meta) meta.textContent = `${t.artists.map(a=>a.name).join(', ')} — ${t.album.name}`; } }

  function updateVinylRotation(){ if(!vinylEl) return; const pos = state.current.position || 0; const dur = state.current.duration || 180000; const spins = pos / dur * 5; const deg = spins * 360; vinylEl.style.transform = `rotate(${deg}deg)`; }
  function ticker(){ requestAnimationFrame(ticker); if(!state.current.paused && state.current.duration){ const nowT = performance.now(); ticker._lt = ticker._lt || nowT; const dt = nowT - ticker._lt; ticker._lt = nowT; state.current.position = Math.min(state.current.duration, state.current.position + dt); seek.value = Math.floor((state.current.position / state.current.duration) * 1000) || 0; updateVinylRotation(); if(modernEl){ modernEl.style.width = `${Math.floor((state.current.position/state.current.duration)*100)}%`; } const t=state.current.track; now.textContent = t ? `${t.name} — ${t.artists.map(a=>a.name).join(', ')} · ${msToClock(state.current.position)} / ${msToClock(state.current.duration)}` : '—'; } else { ticker._lt = performance.now(); } }
  function msToClock(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const r=s%60; return `${m}:${r.toString().padStart(2,'0')}`; }

  // Kick off
  window.addEventListener('DOMContentLoaded', () => {
    const lb = document.getElementById('loginBtn'); if(lb) lb.onclick = startLogin;
    const pop = document.getElementById('popOutBtn'); if(pop) pop.onclick = ()=> window.open(REDIRECT_URI, '_blank', 'noopener');
    document.getElementById('switchThemeBtn').onclick = ()=> showThemeGate();
    document.getElementById('logoutBtn').onclick = logout;
    init();
  });
  </script>
</body>
</html>
